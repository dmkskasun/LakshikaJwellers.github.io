<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lakshika Jewellers - Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&family=Lora:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .font-playfair { font-family: 'Playfair Display', serif; }
        .font-lora { font-family: 'Lora', serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1a1a1a; }
        ::-webkit-scrollbar-thumb { background: #4a4a4a; border-radius: 10px; }
        .nav-link.active { background-color: #D4AF37; color: #111827; }
        .nav-link.active i { color: #111827; }
        #signature-pad { 
            border: 2px dashed #ccc; 
            border-radius: 0.375rem; 
            cursor: crosshair; 
            touch-action: none;
        }

        @media print {
            body > :not(.is-printing) { display: none !important; }
            html, body { height: auto !important; overflow: visible !important; background: #fff !important; font-size: 11pt; }
            .is-printing { position: static !important; display: block !important; visibility: visible !important; padding: 0 !important; margin: 0 !important; background: none !important; }
            .printable-area { position: static !important; width: auto !important; height: auto !important; margin: 0 !important; padding: 0 !important; border: none !important; box-shadow: none !important; color: #000; }
            .no-print { display: none !important; }

            .print-header-wrapper {
                padding: 0.5in !important;
                padding-bottom: 0.25in !important;
                border-bottom: 1px solid #e5e7eb !important;
            }
            .print-header-container {
                display: grid !important;
                grid-template-columns: 1fr 1fr;
                align-items: flex-start;
            }
            .company-details-print { 
                display: block !important; 
            }
            .printable-area .company-details-print img {
                width: 130px !important;
                height: auto !important;
                margin-bottom: 1rem !important;
                border-radius: 0 !important;
            }
            .printable-area .company-details-print h2 {
                font-size: 1.75rem !important; 
                line-height: 1.5rem !important;
                text-transform: uppercase;
                margin-bottom: 0.3rem !important;
            }
            .printable-area .company-details-print p {
                font-size: 0.9rem !important; 
                line-height: 1.25rem !important;
                margin: 0;
            }
            .printable-area .company-details-print .italic {
                margin-bottom: 0.5rem !important;
            }
            .invoice-title-print { 
                text-align: right !important; 
            }
            .printable-area .invoice-title-print h3 {
                font-size: 2.5rem !important;
                margin-bottom: 0.5rem !important;
                font-weight: bold;
                text-transform: uppercase;
            }
            .printable-area .invoice-title-print p {
                font-size: 1rem !important;
            }
            .printable-area .p-6 { padding: 0.5in !important; }
            .p-6 > .grid {
                display: grid !important;
                grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
                align-items: flex-end;
            }
            #signature-pad { 
                border: none !important;
                border-bottom: 1px solid #333 !important;
                height: 80px !important;
                border-radius: 0 !important;
            }
            h4 {
                font-size: 0.85rem !important;
                letter-spacing: 0.05em;
                text-transform: uppercase;
            }
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">

    <div class="flex">
        <aside id="sidebar" class="w-64 bg-gray-800 p-4 flex flex-col fixed h-full z-40 transform -translate-x-full md:translate-x-0 transition-transform duration-300 ease-in-out no-print md:flex">
            <div class="flex items-center justify-between mb-8">
                <div class="flex items-center">
                    <img src="logo.png" alt="Lakshika Jewellers Logo" class="w-12 h-12 mr-2 object-contain">
                    <h1 class="text-xl font-bold text-white">Lakshika Jewellers</h1>
                </div>
                <button id="close-menu-btn" class="md:hidden text-gray-400 hover:text-white"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <nav class="flex-grow">
                <ul>
                    <li><a href="#" data-view="dashboard" class="nav-link active flex items-center py-3 px-4 rounded-lg"><i class="fas fa-tachometer-alt w-6 mr-2"></i> Dashboard</a></li>
                    <li><a href="#" data-view="job-orders" class="nav-link flex items-center py-3 px-4 rounded-lg transition duration-200 hover:bg-gray-700"><i class="fas fa-clipboard-list w-6 mr-2"></i> Job Orders</a></li>
                </ul>
            </nav>
            <div class="mt-auto">
                <a href="#" id="logout-btn" class="nav-link flex items-center py-3 px-4 rounded-lg transition duration-200 hover:bg-gray-700"><i class="fas fa-sign-out-alt w-6 mr-2"></i> Logout</a>
            </div>
        </aside>

        <div class="flex-1 flex flex-col md:ml-64">
            <header class="md:hidden bg-gray-800 p-4 flex justify-between items-center no-print sticky top-0 z-30">
                <button id="menu-toggle-btn" class="text-white"><i class="fas fa-bars text-2xl"></i></button>
                <h1 class="text-lg font-bold text-white">Lakshika Jewellers</h1>
                <div class="w-8"></div> 
            </header>

            <main class="flex-1 p-4 md:p-8 no-print">
                <div id="dashboard-view" class="view">
                    <h2 class="text-3xl font-bold mb-6 text-yellow-400">Dashboard</h2>
                    <p>Welcome to your central control board.</p>
                </div>
                
                <div id="job-orders-view" class="view hidden pb-32 md:pb-0"> 
                    <h2 class="text-3xl font-bold mb-6 text-yellow-400">Create New Job Order</h2>
                    <div class="bg-gray-800 p-4 md:p-8 rounded-xl shadow-lg">
                        <form id="job-order-form">
                            <div class="border-b border-gray-700 pb-6 mb-6">
                                <h3 class="text-xl font-bold text-white mb-4">Customer & Invoice Details</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <input id="job-customer-name" type="text" placeholder="Customer Name" class="bg-gray-700 p-3 rounded-lg w-full">
                                    <input id="job-contact-number" type="text" placeholder="Contact Number" class="bg-gray-700 p-3 rounded-lg w-full">
                                    <input id="job-delivery-date" type="date" class="bg-gray-700 p-3 rounded-lg w-full text-gray-400">
                                    <input id="job-old-gold" type="number" placeholder="Old Gold Value (LKR)" class="bg-gray-700 p-3 rounded-lg w-full">
                                    <input id="job-advance" type="number" placeholder="Advance Payment (LKR)" class="bg-gray-700 p-3 rounded-lg w-full">
                                    <input id="job-remark" type="text" placeholder="Remark" class="bg-gray-700 p-3 rounded-lg w-full md:col-span-2">
                                </div>
                            </div>

                            <div class="border-b border-gray-700 pb-6 mb-6">
                                <h3 class="text-xl font-bold text-white mb-4">Order Items</h3>
                                <div class="p-4 rounded-lg bg-gray-700/50">
                                    <p class="text-gray-400 text-sm mb-4">Use the button below to add or edit items in the order. For each item, you can add unique workshop specifications if it's a custom job.</p>
                                    <button type="button" id="open-item-modal-btn" class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-6 rounded-lg w-full md:w-auto flex items-center justify-center">
                                        <i class="fas fa-plus mr-2"></i> Add New Item to Order
                                    </button>
                                </div>
                                <div class="mt-6 overflow-x-auto">
                                    <table class="w-full text-sm text-left">
                                        <thead class="text-gray-400"><tr><th class="p-2">Description</th><th class="p-2">Price (LKR)</th><th class="p-2 text-right">Actions</th></tr></thead>
                                        <tbody id="order-items-list" class="divide-y divide-gray-700"></tbody>
                                    </table>
                                </div>
                            </div>
                           
                            <div class="mt-8 flex justify-end">
                                <button type="button" id="generate-invoice-btn" class="bg-yellow-400 text-gray-900 font-bold py-3 px-6 rounded-lg hover:bg-yellow-300">Generate Customer Invoice</button>
                            </div>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <div id="job-order-mobile-footer" class="fixed bottom-0 left-0 right-0 bg-gray-800 p-4 border-t border-gray-700 z-30 md:hidden hidden">
        <button type="button" id="generate-invoice-btn-mobile" class="bg-yellow-400 text-gray-900 font-bold py-3 px-6 rounded-lg hover:bg-yellow-300 w-full">Generate Customer Invoice</button>
    </div>

    <div id="item-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center p-2 z-50 no-print">
        <div class="modal-container bg-gray-800 text-gray-200 rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <div class="p-5 border-b border-gray-700"><h3 id="item-modal-title" class="text-2xl font-bold">Add New Item</h3></div>
            <div class="p-6 flex-grow overflow-y-auto space-y-6">
                <div class="border-b border-gray-700 pb-4">
                    <h4 class="text-lg font-semibold text-yellow-400 mb-3">Invoice Details</h4>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="md:col-span-2"><label class="block text-sm">Description</label><input id="modal-item-desc" type="text" class="mt-1 bg-gray-700 p-2 rounded-lg w-full"></div>
                        <div><label class="block text-sm">Karatage</label><select id="modal-item-karatage" class="mt-1 bg-gray-700 p-2 rounded-lg w-full"><option value="">N/A</option><option>22K</option><option>18K</option><option>14K</option></select></div>
                        <div><label class="block text-sm">Weight (g)</label><input id="modal-item-weight" type="number" step="0.001" class="mt-1 bg-gray-700 p-2 rounded-lg w-full"></div>
                        <div class="md:col-span-4"><label class="block text-sm">Price (LKR)</label><input id="modal-item-price" type="number" class="mt-1 bg-gray-700 p-2 rounded-lg w-full"></div>
                    </div>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-yellow-400 mb-3">Workshop Specifications (Optional)</h4>
                     <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><label class="block text-sm">Size</label><input id="modal-ws-size" type="text" class="mt-1 bg-gray-700 p-2 rounded-lg w-full"></div>
                        <div><label class="block text-sm">Stone Size (mm)</label><input id="modal-ws-stone-size" type="text" class="mt-1 bg-gray-700 p-2 rounded-lg w-full"></div>
                        <div><label class="block text-sm">Dimensions (mm)</label><input id="modal-ws-dimensions" type="text" class="mt-1 bg-gray-700 p-2 rounded-lg w-full"></div>
                        <div><label class="block text-sm">Gem Setting</label><select id="modal-ws-gem-setting" class="mt-1 bg-gray-700 p-2 rounded-lg w-full"><option value="">Select</option><option>Prong</option><option>Bezel</option><option>Pave</option></select></div>
                        <div><label class="block text-sm">Stone Weight (carats)</label><input id="modal-ws-stone-weight" type="number" step="0.01" class="mt-1 bg-gray-700 p-2 rounded-lg w-full"></div>
                        <div><label class="block text-sm">Gold Given (g)</label><input id="modal-ws-gold-given" type="number" step="0.001" class="mt-1 bg-gray-700 p-2 rounded-lg w-full"></div>
                        <div class="md:col-span-3 grid grid-cols-2 gap-4">
                           <div><label class="block text-sm">Workshop Wastage (g)</label><input id="modal-ws-wastage" type="text" class="mt-1 bg-gray-600 p-2 rounded-lg w-full" readonly></div>
                           <div><label class="block text-sm">Gold Balance (g)</label><input id="modal-ws-balance" type="text" class="mt-1 bg-gray-600 p-2 rounded-lg w-full" readonly></div>
                        </div>
                        <div class="md:col-span-3">
                            <label class="block text-sm">Design Images</label>
                            <input type="file" id="modal-ws-images" accept="image/*" multiple class="mt-1 block w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-gray-700 file:text-yellow-300 hover:file:bg-gray-600">
                            <div id="modal-ws-image-gallery" class="mt-4 flex flex-wrap gap-4"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-gray-900 border-t border-gray-700 flex justify-end space-x-3">
                <button type="button" id="cancel-item-modal-btn" class="py-2 px-4 bg-gray-600 text-white rounded-lg hover:bg-gray-500">Cancel</button>
                <button type="button" id="save-item-btn" class="py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-500">Save Item</button>
            </div>
        </div>
    </div>
    
    <div id="invoice-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center p-2 z-50">
        <div class="modal-container printable-area bg-white text-gray-800 rounded-lg shadow-2xl w-full max-w-4xl max-h-full flex flex-col">
            <div class="flex-grow overflow-y-auto">
                <div class="p-4 md:p-8 border-b border-gray-200 print-header-wrapper">
                    <div class="w-full flex justify-between items-center print-header-container">
                        <div class="company-details-print">
                            <img src="logo.png" alt="Lakshika Jewellers Logo" class="object-contain">
                            <div class="font-lora">
                                <h2 class="text-3xl font-bold text-gray-900 tracking-wide font-playfair">LAKSHIKA JEWELLERS</h2>
                                <p class="text-md text-gray-600 italic mt-1">Where Luxury Meets Style</p>
                                <p class="text-md text-gray-600 mt-2">No. 220B, Galle Road, Walana, Panadura.</p>
                                <p class="text-md text-gray-600">Tel: 076-4357920, 076-6244372, 076-1576536</p>
                            </div>
                        </div>
                        <div class="invoice-title-print text-right">
                            <h3 class="text-4xl font-bold text-gray-700 font-playfair">INVOICE</h3>
                            <p class="text-base font-lora">ID: <span id="invoice-id" class="font-mono"></span></p>
                            <p class="text-base font-lora">Date: <span id="invoice-date-display"></span></p>
                        </div>
                    </div>
                </div>
                <div class="p-4 md:p-6">
                    <div class="mb-4 pt-4">
                        <h4 class="font-bold text-gray-700 mb-2">CUSTOMER DETAILS</h4>
                        <p id="invoice-customer-name" class="font-semibold"></p>
                        <p id="invoice-customer-contact"></p>
                        <p id="invoice-delivery-date" class="text-sm text-gray-600 mt-1"></p>
                    </div>
                    <div class="mb-4 overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead><tr class="border-b"><th class="p-2 text-left font-bold text-gray-600 w-2/5">DESCRIPTION</th><th class="p-2 text-left font-bold text-gray-600">KARATAGE</th><th class="p-2 text-left font-bold text-gray-600">WEIGHT</th><th class="p-2 text-right font-bold text-gray-600">PRICE (LKR)</th></tr></thead>
                            <tbody id="invoice-items-body"></tbody>
                        </table>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8 border-t pt-4">
                        <div class="text-left">
                            <h4 class="font-bold text-gray-700 mb-2">CUSTOMER SIGNATURE</h4>
                            <canvas id="signature-pad" width="300" height="150"></canvas>
                            <button id="clear-signature-btn" class="mt-2 text-sm text-blue-600 hover:text-blue-800 no-print">Clear Signature</button>
                        </div>
                        <div class="text-left md:text-right">
                            <div class="space-y-2">
                                   <div class="flex justify-between items-center"><p class="text-gray-600">Total Price:</p><p id="invoice-total-price" class="font-bold"></p></div>
                                   <div class="flex justify-between items-center"><p class="text-gray-600">Old Gold Value:</p><p id="invoice-old-gold" class="font-bold"></p></div>
                                   <div class="flex justify-between items-center"><p class="text-gray-600">Advance Payment:</p><p id="invoice-advance" class="font-bold"></p></div>
                                   <div class="flex justify-between items-center text-xl border-t pt-2 mt-2"><p class="font-bold text-gray-800">BALANCE DUE:</p><p id="invoice-balance" class="font-extrabold text-yellow-600"></p></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
             <div class="p-5 bg-gray-50 border-t flex-shrink-0 flex justify-end space-x-3 no-print">
                  <button id="close-invoice-modal-btn" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Close</button>
                  <button id="print-invoice-btn" class="py-2 px-4 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600">Print Invoice</button>
             </div>
        </div>
    </div>
    <div id="workshop-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center p-2 z-50">
        <div class="modal-container printable-area bg-white text-gray-800 rounded-lg shadow-2xl w-full max-w-2xl max-h-full flex flex-col">
            <div class="flex-grow overflow-y-auto p-4 md:p-6">
                <div class="text-center border-b pb-4 mb-4">
                    <h2 class="text-2xl font-bold text-gray-900">WORKSHOP ORDER</h2>
                    <p class="text-sm">Invoice ID: <span id="workshop-invoice-id" class="font-mono"></span> | Date: <span id="workshop-date"></span></p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-4 text-sm">
                    <div><p class="font-bold">Delivery Date:</p><p id="workshop-delivery-date"></p></div>
                    <div><p class="font-bold">Item Description:</p><p id="workshop-item-desc"></p></div>
                    <div><p class="font-bold">Karatage:</p><p id="workshop-karatage-display"></p></div>
                    <div><p class="font-bold">Final Item Weight (g):</p><p id="workshop-item-weight-display"></p></div>
                    <div><p class="font-bold">Workshop Wastage (g):</p><p id="workshop-wastage-display"></p></div>
                    <div><p class="font-bold">Size:</p><p id="workshop-size"></p></div>
                    <div><p class="font-bold">Stone Size:</p><p id="workshop-stone-size"></p></div>
                    <div><p class="font-bold">Dimensions:</p><p id="workshop-dimensions"></p></div>
                    <div><p class="font-bold">Gem Setting:</p><p id="workshop-gem-setting"></p></div>
                    <div><p class="font-bold">Gold Given (g):</p><p id="workshop-gold-given"></p></div>
                    <div><p class="font-bold">Stone Weight (carats):</p><p id="workshop-stone-weight"></p></div>
                    <div><p class="font-bold">Gold Balance to Return (g):</p><p id="workshop-gold-balance"></p></div>
                    <div class="col-span-1 sm:col-span-2">
                        <p class="font-bold">Design Images:</p>
                        <div id="workshop-design-images-container" class="mt-2 flex flex-wrap gap-2"></div>
                    </div>
                </div>
            </div>
            <div class="p-5 bg-gray-50 border-t flex-shrink-0 flex justify-end space-x-3 no-print">
                <button id="close-workshop-modal-btn" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300">Close</button>
                <button id="print-workshop-btn" class="py-2 px-4 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600">Print Order</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    let orderItems = [];
    let currentItemImages = [];
    let currentlyEditingIndex = null;

    // --- CACHE DOM ELEMENTS ---
    const sidebar = document.getElementById('sidebar');
    const menuToggleBtn = document.getElementById('menu-toggle-btn');
    const closeMenuBtn = document.getElementById('close-menu-btn');
    const navLinks = document.querySelectorAll('.nav-link');
    const mobileFooter = document.getElementById('job-order-mobile-footer');
    const views = document.querySelectorAll('.view');
    
    const itemDetailsModal = document.getElementById('item-details-modal');
    const openItemModalBtn = document.getElementById('open-item-modal-btn');
    const cancelItemModalBtn = document.getElementById('cancel-item-modal-btn');
    const saveItemBtn = document.getElementById('save-item-btn');
    const orderItemsList = document.getElementById('order-items-list');
    const itemModalTitle = document.getElementById('item-modal-title');
    
    const modalInputs = {
        desc: document.getElementById('modal-item-desc'),
        karatage: document.getElementById('modal-item-karatage'),
        weight: document.getElementById('modal-item-weight'),
        price: document.getElementById('modal-item-price'),
        wsSize: document.getElementById('modal-ws-size'),
        wsStoneSize: document.getElementById('modal-ws-stone-size'),
        wsDimensions: document.getElementById('modal-ws-dimensions'),
        wsGemSetting: document.getElementById('modal-ws-gem-setting'),
        wsStoneWeight: document.getElementById('modal-ws-stone-weight'),
        wsGoldGiven: document.getElementById('modal-ws-gold-given'),
        wsWastage: document.getElementById('modal-ws-wastage'),
        wsBalance: document.getElementById('modal-ws-balance'),
        wsImages: document.getElementById('modal-ws-images'),
        wsImageGallery: document.getElementById('modal-ws-image-gallery')
    };
    
    const invoiceModal = document.getElementById('invoice-modal');
    const workshopModal = document.getElementById('workshop-modal');

    // --- NAVIGATION ---
    const openSidebar = () => sidebar.classList.remove('-translate-x-full');
    const closeSidebar = () => sidebar.classList.add('-translate-x-full');
    if (menuToggleBtn) menuToggleBtn.addEventListener('click', openSidebar);
    if (closeMenuBtn) closeMenuBtn.addEventListener('click', closeSidebar);
    document.getElementById('logout-btn').addEventListener('click', (e) => { e.preventDefault(); });
    navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const viewId = this.dataset.view;
            if (!viewId) return;
            views.forEach(view => view.classList.add('hidden'));
            document.getElementById(viewId + '-view').classList.remove('hidden');
            navLinks.forEach(nav => nav.classList.remove('active'));
            this.classList.add('active');
            if (mobileFooter) mobileFooter.classList.toggle('hidden', viewId !== 'job-orders');
            if (window.innerWidth < 768) closeSidebar();
        });
    });

    // --- PER-ITEM MODAL LOGIC (ADD & EDIT) ---
    const resetItemModal = () => {
        Object.values(modalInputs).forEach(input => { if (input.type !== 'file') input.value = ''; });
        currentItemImages = [];
        renderModalImageGallery();
        currentlyEditingIndex = null;
    };

    const openModalForAdd = () => {
        resetItemModal();
        itemModalTitle.textContent = 'Add New Item';
        saveItemBtn.textContent = 'Save Item to Order';
        itemDetailsModal.classList.remove('hidden');
    };

    const openModalForEdit = (index) => {
        resetItemModal();
        const item = orderItems[index];
        currentlyEditingIndex = index;

        modalInputs.desc.value = item.description;
        modalInputs.karatage.value = item.karatage;
        modalInputs.weight.value = item.weight;
        modalInputs.price.value = item.price;
        if (item.isWorkshopJob) {
            const specs = item.workshopSpecs;
            modalInputs.wsSize.value = specs.size;
            modalInputs.wsStoneSize.value = specs.stoneSize;
            modalInputs.wsDimensions.value = specs.dimensions;
            modalInputs.wsGemSetting.value = specs.gemSetting;
            modalInputs.wsStoneWeight.value = specs.stoneWeight;
            modalInputs.wsGoldGiven.value = specs.goldGiven;
            calculateModalWastage(); 
            currentItemImages = [...specs.images];
            renderModalImageGallery();
        }

        itemModalTitle.textContent = 'Edit Item';
        saveItemBtn.textContent = 'Update Item';
        itemDetailsModal.classList.remove('hidden');
    };
    
    openItemModalBtn.addEventListener('click', openModalForAdd);
    cancelItemModalBtn.addEventListener('click', () => itemDetailsModal.classList.add('hidden'));

    const calculateModalWastage = () => {
        const karatage = modalInputs.karatage.value;
        const weight = parseFloat(modalInputs.weight.value) || 0;
        const goldGiven = parseFloat(modalInputs.wsGoldGiven.value) || 0;
        let wastage = 0;
        if (weight > 0 && karatage) {
            wastage = (karatage === '22K') ? (weight / 8) * 0.45 : weight * 0.10;
        }
        const balance = goldGiven - (weight + wastage);
        modalInputs.wsWastage.value = wastage.toFixed(3);
        modalInputs.wsBalance.value = balance.toFixed(3);
    };

    [modalInputs.karatage, modalInputs.weight, modalInputs.wsGoldGiven].forEach(el => el.addEventListener('input', calculateModalWastage));

    const renderModalImageGallery = () => {
        modalInputs.wsImageGallery.innerHTML = '';
        currentItemImages.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = e => {
                const previewWrapper = document.createElement('div');
                previewWrapper.className = 'relative w-24 h-24';
                previewWrapper.innerHTML = `
                    <img src="${e.target.result}" class="w-full h-full object-cover rounded-md">
                    <button type="button" data-index="${index}" class="remove-image-btn absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">&times;</button>
                `;
                modalInputs.wsImageGallery.appendChild(previewWrapper);
            };
            reader.readAsDataURL(file);
        });
    };
    modalInputs.wsImages.addEventListener('change', (e) => {
        currentItemImages.push(...Array.from(e.target.files));
        renderModalImageGallery();
        e.target.value = '';
    });
    modalInputs.wsImageGallery.addEventListener('click', (e) => {
        const removeBtn = e.target.closest('.remove-image-btn');
        if (removeBtn) {
            currentItemImages.splice(parseInt(removeBtn.dataset.index, 10), 1);
            renderModalImageGallery();
        }
    });

    saveItemBtn.addEventListener('click', () => {
        const description = modalInputs.desc.value.trim();
        const price = parseFloat(modalInputs.price.value);
        if (!description || isNaN(price) || price <= 0) {
            alert('A valid Description and Price are required.');
            return;
        }
        
        const size = modalInputs.wsSize.value.trim();
        const stoneSize = modalInputs.wsStoneSize.value.trim();
        const dimensions = modalInputs.wsDimensions.value.trim();
        const goldGiven = parseFloat(modalInputs.wsGoldGiven.value) || 0;

        const isWorkshopJob = goldGiven > 0 || size || stoneSize || dimensions || currentItemImages.length > 0;
        
        const newItemData = {
            description, price,
            karatage: modalInputs.karatage.value,
            weight: parseFloat(modalInputs.weight.value) || 0,
            isWorkshopJob: isWorkshopJob,
            workshopSpecs: {
                size: size,
                stoneSize: stoneSize,
                dimensions: dimensions,
                gemSetting: modalInputs.wsGemSetting.value,
                stoneWeight: parseFloat(modalInputs.wsStoneWeight.value) || 0,
                goldGiven: goldGiven,
                wastage: parseFloat(modalInputs.wsWastage.value) || 0,
                balance: parseFloat(modalInputs.wsBalance.value) || 0,
                images: [...currentItemImages]
            }
        };

        if (currentlyEditingIndex !== null) {
            orderItems[currentlyEditingIndex] = newItemData;
        } else {
            orderItems.push(newItemData);
        }

        renderOrderItems();
        itemDetailsModal.classList.add('hidden');
    });

    const renderOrderItems = () => {
        orderItemsList.innerHTML = orderItems.length === 0 
            ? '<tr><td colspan="3" class="text-center text-gray-500 p-4">No items in this order.</td></tr>'
            : orderItems.map((item, index) => `
                <tr>
                    <td class="p-2 align-middle">${item.description} ${item.isWorkshopJob ? '<span class="text-xs bg-blue-500/50 text-blue-300 rounded-full px-2 py-1 ml-2">Custom</span>' : ''}</td>
                    <td class="p-2 align-middle">LKR ${item.price.toFixed(2)}</td>
                    <td class="p-2 text-right align-middle">
                        ${item.isWorkshopJob ? `<button type="button" data-index="${index}" class="print-workshop-btn text-blue-400 hover:text-blue-300 p-2" title="Print Workshop Order"><i class="fas fa-print"></i></button>` : ''}
                        <button type="button" data-index="${index}" class="edit-item-btn text-green-400 hover:text-green-300 p-2" title="Edit Item"><i class="fas fa-edit"></i></button>
                        <button type="button" data-index="${index}" class="remove-item-btn text-red-400 hover:text-red-300 p-2" title="Remove Item"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>`).join('');
    };

    orderItemsList.addEventListener('click', e => {
        const printBtn = e.target.closest('.print-workshop-btn');
        const editBtn = e.target.closest('.edit-item-btn');
        const removeBtn = e.target.closest('.remove-item-btn');
        
        if (printBtn) {
            populateAndShowWorkshopModal(parseInt(printBtn.dataset.index, 10));
        }
        if (editBtn) {
            openModalForEdit(parseInt(editBtn.dataset.index, 10));
        }
        if (removeBtn) {
            orderItems.splice(parseInt(removeBtn.dataset.index, 10), 1);
            renderOrderItems();
        }
    });

    const populateAndShowWorkshopModal = (itemIndex) => {
        const item = orderItems[itemIndex];
        if (!item || !item.isWorkshopJob) return;
        const specs = item.workshopSpecs;
        
        workshopModal.querySelector('#workshop-invoice-id').textContent = '#2514';
        workshopModal.querySelector('#workshop-date').textContent = new Date().toLocaleDateString('en-CA');
        workshopModal.querySelector('#workshop-delivery-date').textContent = document.getElementById('job-delivery-date').value;
        workshopModal.querySelector('#workshop-item-desc').textContent = item.description;
        workshopModal.querySelector('#workshop-karatage-display').textContent = item.karatage;
        workshopModal.querySelector('#workshop-item-weight-display').textContent = (item.weight || 0).toFixed(3) + ' g';
        workshopModal.querySelector('#workshop-wastage-display').textContent = specs.wastage.toFixed(3) + ' g';
        workshopModal.querySelector('#workshop-gold-balance').textContent = specs.balance.toFixed(3) + ' g';
        workshopModal.querySelector('#workshop-size').textContent = specs.size;
        workshopModal.querySelector('#workshop-stone-size').textContent = specs.stoneSize;
        workshopModal.querySelector('#workshop-dimensions').textContent = specs.dimensions;
        workshopModal.querySelector('#workshop-gem-setting').textContent = specs.gemSetting;
        workshopModal.querySelector('#workshop-gold-given').textContent = specs.goldGiven.toFixed(3) + ' g';
        workshopModal.querySelector('#workshop-stone-weight').textContent = specs.stoneWeight.toFixed(2) + ' carats';
        
        const imageContainer = workshopModal.querySelector('#workshop-design-images-container');
        imageContainer.innerHTML = '';
        specs.images.forEach(file => {
            const reader = new FileReader();
            reader.onload = e => imageContainer.innerHTML += `<img src="${e.target.result}" class="rounded-lg w-32 h-32 object-cover">`;
            reader.readAsDataURL(file);
        });

        workshopModal.classList.remove('hidden');
    };
    
    const generateInvoiceAction = () => {
        if (orderItems.length === 0) {
            alert('Cannot generate an invoice with no items. Please add at least one item.');
            return;
        }
        const totalPrice = orderItems.reduce((sum, item) => sum + item.price, 0);
        const oldGoldValue = parseFloat(document.getElementById('job-old-gold').value) || 0;
        const advance = parseFloat(document.getElementById('job-advance').value) || 0;
        const balance = totalPrice - oldGoldValue - advance;

        invoiceModal.querySelector('#invoice-id').textContent = '#2514';
        invoiceModal.querySelector('#invoice-date-display').textContent = '2025-08-16';
        invoiceModal.querySelector('#invoice-customer-name').textContent = document.getElementById('job-customer-name').value;
        invoiceModal.querySelector('#invoice-customer-contact').textContent = document.getElementById('job-contact-number').value;
        invoiceModal.querySelector('#invoice-delivery-date').textContent = `Delivery by: ${document.getElementById('job-delivery-date').value}`;
        
        invoiceModal.querySelector('#invoice-items-body').innerHTML = orderItems.map(item => `
            <tr class="border-b">
                <td class="p-2">${item.description}</td>
                <td class="p-2">${item.karatage || 'N/A'}</td>
                <td class="p-2">${item.weight ? item.weight.toFixed(3) + ' g' : 'N/A'}</td>
                <td class="p-2 text-right">LKR ${item.price.toFixed(2)}</td>
            </tr>`).join('');
        
        invoiceModal.querySelector('#invoice-total-price').textContent = `LKR ${totalPrice.toFixed(2)}`;
        invoiceModal.querySelector('#invoice-old-gold').textContent = `LKR ${oldGoldValue.toFixed(2)}`;
        invoiceModal.querySelector('#invoice-advance').textContent = `LKR ${advance.toFixed(2)}`;
        invoiceModal.querySelector('#invoice-balance').textContent = `LKR ${balance.toFixed(2)}`;
        
        invoiceModal.classList.remove('hidden');
    };
    
    document.getElementById('generate-invoice-btn').addEventListener('click', generateInvoiceAction);
    document.getElementById('generate-invoice-btn-mobile').addEventListener('click', generateInvoiceAction);
    
    // --- SIGNATURE PAD SCRIPT ---
    const signaturePadCanvas = document.getElementById('signature-pad');
    if (signaturePadCanvas) {
        const ctx = signaturePadCanvas.getContext('2d');
        let isDrawing = false, lastX = 0, lastY = 0;
        const initializeSignaturePad = () => Object.assign(ctx, { strokeStyle: '#000', lineWidth: 2, lineCap: 'round', lineJoin: 'round' });
        const getCoords = (e) => {
            const rect = signaturePadCanvas.getBoundingClientRect();
            const touch = e.touches && e.touches[0];
            return {
                x: (touch ? touch.clientX : e.clientX) - rect.left,
                y: (touch ? touch.clientY : e.clientY) - rect.top
            };
        };
        const startDrawing = (e) => { e.preventDefault(); isDrawing = true; [lastX, lastY] = [getCoords(e).x, getCoords(e).y]; };
        const draw = (e) => {
            if (!isDrawing) return;
            e.preventDefault();
            const { x, y } = getCoords(e);
            ctx.beginPath();
            ctx.moveTo(lastX, lastY);
            ctx.lineTo(x, y);
            ctx.stroke();
            [lastX, lastY] = [x, y];
        };
        const stopDrawing = () => { isDrawing = false; };

        ['mousedown', 'touchstart'].forEach(event => signaturePadCanvas.addEventListener(event, startDrawing, { passive: false }));
        ['mousemove', 'touchmove'].forEach(event => signaturePadCanvas.addEventListener(event, draw, { passive: false }));
        ['mouseup', 'mouseleave', 'touchend'].forEach(event => signaturePadCanvas.addEventListener(event, stopDrawing));

        document.getElementById('clear-signature-btn').addEventListener('click', () => {
            ctx.clearRect(0, 0, signaturePadCanvas.width, signaturePadCanvas.height);
        });
        
        initializeSignaturePad();
    }

    // --- PRINT & MODAL CLOSE CONTROLS ---
    let isPrinting = false; 
    const handlePrint = (modalToPrint) => {
        if (isPrinting || !modalToPrint) return;
        isPrinting = true;
        modalToPrint.classList.add('is-printing');
        window.print();
    };
    window.addEventListener('afterprint', () => {
        const printedModal = document.querySelector('.is-printing');
        if (printedModal) printedModal.classList.remove('is-printing');
        isPrinting = false;
    });

    document.getElementById('close-invoice-modal-btn').addEventListener('click', () => invoiceModal.classList.add('hidden'));
    document.getElementById('print-invoice-btn').addEventListener('click', () => handlePrint(invoiceModal));
    document.getElementById('close-workshop-modal-btn').addEventListener('click', () => workshopModal.classList.add('hidden'));
    document.getElementById('print-workshop-btn').addEventListener('click', () => handlePrint(workshopModal));
    
    renderOrderItems();
});
</script>
</body>
</html>